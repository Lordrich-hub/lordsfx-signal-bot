<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forex Signal Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #111; color: white; }
    .card { background-color: #1e1e1e; }
    .score-table td { padding: 0.25rem 0.5rem; border-bottom: 1px solid #444; }
    .confidence-bar {
      width: 100%;
      background-color: #444;
      border-radius: 8px;
      overflow: hidden;
      height: 18px;
    }
    .confidence-fill {
      height: 100%;
      text-align: center;
      color: white;
      font-size: 0.75rem;
      line-height: 18px;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="text-center">üìà LordsFx Signal Provider</h1>
    <div class="text-center my-4">
      <label for="pairSelector" class="form-label">Choose a Forex Pair:</label>
      <select id="pairSelector" class="form-select w-50 mx-auto mb-3">
        <option value="EUR/USD">EUR/USD</option>
        <option value="GBP/USD">GBP/USD</option>
        <option value="USD/JPY">USD/JPY</option>
        <option value="GBP/JPY">GBP/JPY</option>
        <option value="USD/CHF">USD/CHF</option>
        <option value="GBP/CHF">GBP/CHF</option>
        <option value="AUD/USD">AUD/USD</option>
        <option value="CHF/JPY">CHF/JPY</option>
      </select>
      <button class="btn btn-primary" onclick="checkSignal()">Check Market Signal</button>
    </div>
    <div id="signalBox" class="text-center"></div>
  </div>

  <script>
    function SMA(values, length) {
      return values.slice(-length).reduce((a, b) => a + b, 0) / length;
    }

    function EMA(values, length) {
      const k = 2 / (length + 1);
      let ema = values[0];
      const result = [ema];
      for (let i = 1; i < values.length; i++) {
        ema = values[i] * k + ema * (1 - k);
        result.push(ema);
      }
      return result;
    }

    function ADX(highs, lows, closes, period = 14) {
      const plusDI = [], minusDI = [], tr = [];
      for (let i = 1; i < highs.length; i++) {
        const upMove = highs[i] - highs[i - 1];
        const downMove = lows[i - 1] - lows[i];
        plusDI.push(upMove > downMove && upMove > 0 ? upMove : 0);
        minusDI.push(downMove > upMove && downMove > 0 ? downMove : 0);
        tr.push(Math.max(highs[i] - lows[i], Math.abs(highs[i] - closes[i - 1]), Math.abs(lows[i] - closes[i - 1])));
      }
      const tr14 = SMA(tr.slice(-period), period);
      const plusDI14 = (SMA(plusDI.slice(-period), period) / tr14) * 100;
      const minusDI14 = (SMA(minusDI.slice(-period), period) / tr14) * 100;
      return Math.abs((plusDI14 - minusDI14) / (plusDI14 + minusDI14)) * 100;
    }

    async function checkSignal() {
      const selectedPair = document.getElementById("pairSelector").value;
      const url = `https://api.twelvedata.com/time_series?symbol=${selectedPair}&interval=15min&outputsize=100&apikey=3d9c9f67fe414e5cb949cda6af723aef`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const closes = data.values.map(x => parseFloat(x.close)).reverse();
        const highs = data.values.map(x => parseFloat(x.high)).reverse();
        const lows = data.values.map(x => parseFloat(x.low)).reverse();

        const latestPrice = closes[closes.length - 1];
        let buys = 0, sells = 0;
        const breakdown = [];

        function RSI(values, period = 14) {
          let gains = 0, losses = 0;
          for (let i = 1; i <= period; i++) {
            const change = values[i] - values[i - 1];
            if (change > 0) gains += change;
            else losses -= change;
          }
          let avgGain = gains / period;
          let avgLoss = losses / period;
          const rs = avgGain / avgLoss;
          return 100 - (100 / (1 + rs));
        }

        function MACDHistogram(values, fast = 12, slow = 26, signal = 9) {
          const fastEMA = EMA(values, fast);
          const slowEMA = EMA(values, slow);
          const macdLine = fastEMA.map((v, i) => v - slowEMA[i]);
          const signalLine = EMA(macdLine, signal);
          return macdLine[macdLine.length - 1] - signalLine[signalLine.length - 1];
        }

        function StochK(highs, lows, closes, period = 9) {
          const high = Math.max(...highs.slice(-period));
          const low = Math.min(...lows.slice(-period));
          const close = closes[closes.length - 1];
          return ((close - low) / (high - low)) * 100;
        }

        function CCI(closes, highs, lows, period = 14) {
          const tp = closes.map((c, i) => (c + highs[i] + lows[i]) / 3);
          const sma = SMA(tp, period);
          const md = tp.slice(-period).reduce((sum, val) => sum + Math.abs(val - sma), 0) / period;
          return ((tp[tp.length - 1] - sma) / (0.015 * md));
        }

        function WilliamsR(closes, highs, lows, period = 14) {
          const high = Math.max(...highs.slice(-period));
          const low = Math.min(...lows.slice(-period));
          const close = closes[closes.length - 1];
          return ((high - close) / (high - low)) * -100;
        }

        function ROC(closes, period = 14) {
          return ((closes[closes.length - 1] - closes[closes.length - 1 - period]) / closes[closes.length - 1 - period]) * 100;
        }

        function ATR(highs, lows, closes, period = 14) {
          const trs = [];
          for (let i = 1; i < highs.length; i++) {
            const high = highs[i];
            const low = lows[i];
            const prevClose = closes[i - 1];
            trs.push(Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose)));
          }
          return SMA(trs.slice(-period), period);
        }

        const maPeriods = [5, 10, 20, 50, 100, 200];
        maPeriods.forEach(period => {
          const sma = SMA(closes, period);
          const ema = EMA(closes, period).slice(-1)[0];
          const smaSignal = latestPrice > sma ? 'BUY' : 'SELL';
          const emaSignal = latestPrice > ema ? 'BUY' : 'SELL';
          if (smaSignal === 'BUY') buys++; else sells++;
          if (emaSignal === 'BUY') buys++; else sells++;
          breakdown.push(`<tr><td>SMA${period}</td><td>${sma.toFixed(5)}</td><td class='text-${smaSignal === 'BUY' ? 'success' : 'danger'}'>${smaSignal}</td></tr>`);
          breakdown.push(`<tr><td>EMA${period}</td><td>${ema.toFixed(5)}</td><td class='text-${emaSignal === 'BUY' ? 'success' : 'danger'}'>${emaSignal}</td></tr>`);
        });

        const indicators = [
          { name: "RSI", value: RSI(closes), logic: v => v > 50 },
          { name: "MACD Histogram", value: MACDHistogram(closes), logic: v => v > 0 },
          { name: "Stochastic %K", value: StochK(highs, lows, closes), logic: v => v > 50 },
          { name: "CCI", value: CCI(closes, highs, lows), logic: v => v > 0 },
          { name: "Williams %R", value: WilliamsR(closes, highs, lows), logic: v => v > -50 },
          { name: "ROC", value: ROC(closes), logic: v => v > 0 },
          { name: "ATR", value: ATR(highs, lows, closes), logic: v => v > 0.001 },
          { name: "ADX", value: ADX(highs, lows, closes), logic: v => v > 20 }
        ];

        indicators.forEach(ind => {
          const decision = ind.logic(ind.value) ? 'BUY' : 'SELL';
          if (decision === 'BUY') buys++; else sells++;
          breakdown.push(`<tr><td>${ind.name}</td><td>${ind.value.toFixed(2)}</td><td class='text-${decision === 'BUY' ? 'success' : 'danger'}'>${decision}</td></tr>`);
        });

        const totalVotes = buys + sells;
        const confidence = Math.floor((Math.max(buys, sells) / totalVotes) * 100);
        const signal = buys > sells ? 'BUY' : sells > buys ? 'SELL' : 'NONE';
        const confidenceColor = signal === 'BUY' ? 'green' : signal === 'SELL' ? 'red' : '#666';

        let signalHTML = "<div class='card text-white p-4'>";
        signalHTML += `<h3>‚ôæ ${selectedPair} ${signal === 'BUY' ? 'BUY' : signal === 'SELL' ? 'SELL' : 'NO'} SIGNAL</h3>`;

        if (signal === 'BUY') {
          signalHTML += `<p>üìç Entry: ${latestPrice.toFixed(3)}</p>
            <p>üî¥ SL: ${(latestPrice * 0.99).toFixed(3)}</p>
            <p>üí∞ TP1: ${(latestPrice * 1.01).toFixed(3)}</p>
            <p>üí∞ TP2: ${(latestPrice * 1.014).toFixed(3)}</p>`;
        } else if (signal === 'SELL') {
          signalHTML += `<p>üìç Entry: ${latestPrice.toFixed(3)}</p>
            <p>üî¥ SL: ${(latestPrice * 1.01).toFixed(3)}</p>
            <p>üí∞ TP1: ${(latestPrice * 0.99).toFixed(3)}</p>
            <p>üí∞ TP2: ${(latestPrice * 0.986).toFixed(3)}</p>`;
        } else {
          signalHTML += `<p>No trade opportunity right now.</p>`;
        }

        signalHTML += `<p>üìä LordsFx Signal | ‚è≥ Expires in 2 Hours | M15 Chart</p>`;
        signalHTML += `<div class='mt-3'><h5>üìã Indicator Breakdown</h5><table class='table table-sm text-white score-table mx-auto'><thead><tr><th>Indicator</th><th>Value</th><th>Signal</th></tr></thead><tbody>${breakdown.join('')}</tbody></table></div>`;
        signalHTML += `<div class='mt-2'><p class='fw-bold'>üìà Total: ${buys} BUY / ${sells} SELL</p>
          <div class='confidence-bar mt-2'><div class='confidence-fill' style='width:${confidence}%; background:${confidenceColor}'>Confidence: ${confidence}%</div></div></div>`;
        signalHTML += `</div>`;

        document.getElementById("signalBox").innerHTML = signalHTML;
      } catch (err) {
        document.getElementById("signalBox").innerHTML = `<div class='alert alert-danger'>Error loading signal: ${err.message}</div>`;
      }
    }
  </script>
</body>
</html>
